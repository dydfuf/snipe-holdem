# 저격 홀덤 FSM 테스트 스위트

*최종 업데이트: 2025-06-15*

이 디렉토리는 저격 홀덤 FSM 패키지의 포괄적인 테스트 스위트를 포함합니다. 모든 테스트는 `game-rule.md`의 공식 규칙과 `AGENTS.md`의 코딩 표준을 준수합니다.

## 📋 테스트 파일 개요

### 🎯 엔드투엔드 테스트

#### `e2e-simple.test.ts` (330줄)
**핵심 게임 플로우 검증**
- ✅ 기본 2명/3명/6명 게임 시작부터 베팅 라운드까지
- ✅ 인원수별 칩 배분 (100/90/80/70/60칩)
- ✅ 40장 덱 시스템 (1-10 숫자 카드)
- ✅ 저격 시스템 기본 검증 (중복 방지)
- ✅ 생존 확정 시스템 (시작칩+15개)
- ✅ 게임 종료 조건 판단
- ✅ 성능 및 안정성 (5게임 500ms 이내)

#### `e2e-game-scenarios.test.ts` (482줄)
**복잡한 게임 시나리오 검증**
- ✅ 완전한 게임 플로우 시뮬레이션
- ✅ 저격 성공/실패 시나리오
- ✅ 생존 확정 및 칩 분배
- ✅ 멀티 라운드 진행
- ✅ 에러 처리 및 엣지 케이스
- ✅ 메모리 누수 방지 (10게임 인스턴스)
- ✅ 게임 규칙 준수 검증

### 🎰 베팅 시스템 테스트

#### `betting-integration.test.ts` (406줄)
**베팅 머신과 게임 머신 통합**
- ✅ 베팅 머신 단독 테스트
- ✅ 게임 머신과의 통합 테스트
- ✅ 베팅 라운드 진입 및 완료
- ✅ 다양한 베팅 시나리오 (2명/3명)
- ✅ 올인 상황 처리
- ✅ 성능 테스트 (대규모 플레이어)

#### `betting-actions.test.ts` (345줄)
**베팅 액션 유틸리티 검증**
- ✅ 베팅 한도 계산 (최저 보유 칩 기준)
- ✅ 베팅 액션 검증 (콜/레이즈/올인)
- ✅ 베팅 라운드 종료 조건
- ✅ 베팅 순서 관리 (딜러 기준 시계방향)
- ✅ 팟 계산 및 사이드 팟
- ✅ 베팅 검증 함수들

### 🎯 저격 시스템 테스트

#### `snipe-integration.test.ts` (196줄)
**저격 시스템 통합 테스트**
- ✅ 저격 선언 및 처리
- ✅ 중복 저격 방지
- ✅ 저격 성공/실패 판정
- ✅ 족보 강등 처리
- ✅ 생존 확정과의 연동

### 🔧 유틸리티 테스트

#### `utils.test.ts` (294줄)
**핵심 유틸리티 함수 검증**
- ✅ 덱 관리 (40장 검증)
- ✅ 핸드 평가 (모든 족보)
- ✅ 핸드 비교 (우선순위/킥커)
- ✅ 저격 적용 (강등 메커니즘)
- ✅ 엣지 케이스 처리

### 🎮 통합 FSM 테스트

#### `fsm.test.ts` (494줄)
**전체 FSM 시스템 검증**
- ✅ 플레이어 수별 시작 칩 검증
- ✅ 저격 시스템 포괄 테스트
- ✅ 생존 확정 시스템 테스트
- ✅ 40장 덱 시스템 검증
- ✅ 성능 및 메모리 테스트

## 🎯 테스트 커버리지

### 게임 규칙 커버리지 (game-rule.md 기준)
- ✅ **섹션 1**: 기본 구성 (40장 덱, 인원별 칩)
- ✅ **섹션 2**: 게임 흐름 (전체 플로우)
- ✅ **섹션 3**: 족보 등급 (7단계 모두)
- ✅ **섹션 4**: 저격 규정 (중복 방지, 강등)
- ✅ **섹션 5**: 베팅 규칙 (한도, 액션)
- ✅ **섹션 6**: 동점 규칙 (우선순위)
- ✅ **섹션 7**: 예외 처리

### 코딩 표준 준수 (AGENTS.md 기준)
- ✅ **순수 함수**: 모든 테스트 결정론적
- ✅ **타입 안전성**: TypeScript strict 모드
- ✅ **에러 처리**: 우아한 실패 처리
- ✅ **성능**: 응답 시간 검증
- ✅ **메모리**: 누수 방지 검증

## 🚀 테스트 실행

### 전체 테스트 실행
```bash
# 모든 테스트 실행
pnpm -F @repo/fsm test

# 커버리지 포함
pnpm -F @repo/fsm test --coverage
```

### 개별 테스트 실행
```bash
# 엔드투엔드 테스트만
npx vitest run tests/e2e-simple.test.ts

# 베팅 시스템 테스트만
npx vitest run tests/betting-integration.test.ts

# 저격 시스템 테스트만
npx vitest run tests/snipe-integration.test.ts
```

### 감시 모드
```bash
# 개발 중 자동 테스트
pnpm -F @repo/fsm dev
```

## 📊 테스트 통계

| 카테고리 | 파일 수 | 총 라인 수 | 테스트 케이스 |
|---------|--------|-----------|-------------|
| 엔드투엔드 | 2 | 812줄 | ~50개 |
| 베팅 시스템 | 2 | 751줄 | ~40개 |
| 저격 시스템 | 1 | 196줄 | ~15개 |
| 유틸리티 | 1 | 294줄 | ~25개 |
| FSM 통합 | 1 | 494줄 | ~30개 |
| **총계** | **7** | **2,547줄** | **~160개** |

## 🎯 테스트 시나리오 하이라이트

### 실제 게임 시나리오
1. **2명 기본 게임**: 시작→베팅→저격→생존확정
2. **3명 저격 게임**: 중복 저격 방지, 족보 강등
3. **6명 복잡 게임**: 멀티 라운드, 다양한 상황
4. **올인 상황**: 사이드 팟, 칩 분배
5. **생존 확정**: 자동 처리, 게임 종료

### 에러 처리 시나리오
1. **잘못된 이벤트**: 상태별 무시 처리
2. **플레이어 수 부족**: 게임 시작 방지
3. **중복 참여**: 자동 필터링
4. **메모리 누수**: 다중 게임 인스턴스

### 성능 시나리오
1. **빠른 게임 생성**: 5게임 500ms 이내
2. **대규모 처리**: 100개 액션 1초 이내
3. **메모리 효율성**: 10게임 동시 실행

## 🔍 디버깅 가이드

### 테스트 실패 시 확인사항
1. **게임 상태**: `actor.getSnapshot().value`
2. **컨텍스트**: `actor.getSnapshot().context`
3. **버전**: 단조 증가 확인
4. **플레이어 상태**: 칩, 베팅, 폴드 여부

### 일반적인 문제
1. **베팅 머신 통합**: onDone 이벤트 처리
2. **저격 중복**: 선언 배열 상태 확인
3. **생존 확정**: 칩 계산 로직
4. **덱 관리**: 40장 유지 확인

---

 